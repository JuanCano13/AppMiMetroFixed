<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppMiMetro - Iniciar Sesión</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
</head>
<body>
<aside class="sidebar">
    <div class="app-title">
        <i class="fas fa-train-subway"></i> AppMiMetro
    </div>
    <nav class="sidebar-nav">
        <ul>
            <li><a href="login.html" class="active"><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</a></li>
            <li><a href="index.html"><i class="fas fa-user-plus"></i> Registrarse</a></li>
        </ul>
    </nav>
</aside>
<main class="main-content">
    <h1>Iniciar Sesión</h1>
    <div class="alert-panel form-wrapper">
        <form id="loginForm">
            <label for="username">Usuario</label>
            <input type="text" id="username" placeholder="ej. juanperez" required>

            <label for="password">Contraseña</label>
            <div class="password-wrapper">
                <input type="password" id="password" placeholder="Ingresa tu contraseña" required>
                <i class="fas fa-eye toggle-password" id="togglePassword"></i>
            </div>

            <button type="submit" id="submitBtn">
                <span class="loader" id="loader" style="display: none;"></span>
                <span id="buttonText">Iniciar Sesión</span>
            </button>

            <p style="margin-top:1rem; text-align:center;">
                ¿No tienes cuenta?
                <a href="index.html" style="color: var(--green); text-decoration: none;">Regístrate</a>
            </p>
            <p id="response" class="response-message" style="text-align:center;margin-top:0.5rem;"></p>
        </form>
    </div>
</main>

<script>
    document.getElementById("loginForm").addEventListener("submit", function(event) {
        event.preventDefault();
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const responseMessageElement = document.getElementById("response");
        const loader = document.getElementById("loader");
        const buttonText = document.getElementById("buttonText");
        const submitBtn = document.getElementById("submitBtn");

        // Mostrar loader y deshabilitar botón
        loader.style.display = "inline-block";
        buttonText.textContent = "Procesando...";
        submitBtn.disabled = true;

        responseMessageElement.innerText = "";
        responseMessageElement.className = "response-message";
        responseMessageElement.style.display = "none";

        console.log("Intentando login con:", username);
        const user = { username, password };

        fetch("http://localhost:8081/api/usuarios/login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(user)
        })
            .then(response => {
                console.log("Respuesta recibida. Status:", response.status);
                // Verificar si la respuesta es JSON
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    return response.json().then(data => {
                        return { data, status: response.status, ok: response.ok };
                    });
                } else {
                    return response.text().then(text => {
                        return {
                            data: { message: text },
                            status: response.status,
                            ok: response.ok
                        };
                    });
                }
            })
            .then(({data, status, ok}) => {
                console.log("Datos procesados:", data);
                if (ok && status === 200) {
                    // ✅ Login exitoso
                    responseMessageElement.innerText = "✅ " + (data.message || "Login exitoso");
                    responseMessageElement.className = "response-message success";
                    responseMessageElement.style.display = "block";

                    // Guardar en localStorage
                    if (data.username) {
                        localStorage.setItem('username', data.username);
                        console.log("Usuario guardado:", data.username);
                    }
                    if (data.id) {
                        localStorage.setItem('userId', data.id);
                    }

                    console.log("Redirigiendo a dashboard...");
                    // Pequeña demora para que el usuario vea el mensaje de éxito
                    setTimeout(() => {
                        window.location.href = "dashboard.html";
                    }, 1000);
                } else {
                    // ❌ Login fallido
                    responseMessageElement.innerText = "❌ " + (data.message || "Error de autenticación. Código: " + status);
                    responseMessageElement.className = "response-message error";
                    responseMessageElement.style.display = "block";
                    console.error("Error de login:", data);

                    // Restaurar botón
                    loader.style.display = "none";
                    buttonText.textContent = "Iniciar Sesión";
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error("Error de conexión:", error);
                responseMessageElement.innerText = "❌ Error de conexión: " + error.message;
                responseMessageElement.className = "response-message error";
                responseMessageElement.style.display = "block";

                // Restaurar botón
                loader.style.display = "none";
                buttonText.textContent = "Iniciar Sesión";
                submitBtn.disabled = false;
            });
    });

    // Funcionalidad para mostrar/ocultar contraseña
    document.getElementById("togglePassword").addEventListener("click", function() {
        const passwordInput = document.getElementById("password");
        const icon = this;

        if (passwordInput.type === "password") {
            passwordInput.type = "text";
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
        } else {
            passwordInput.type = "password";
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
        }
    });
</script>

<style>
    /* Estilos adicionales para el loader y mensajes de respuesta */
    .loader {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid var(--green);
        border-radius: 50%;
        border-top-color: var(--bg-dark);
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
        vertical-align: middle;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .response-message {
        margin-top: 1rem;
        padding: 0.5rem;
        border-radius: 8px;
        font-weight: 500;
    }

    .success {
        background-color: rgba(74, 222, 128, 0.2);
        color: var(--green);
        border: 1px solid var(--green);
    }

    .error {
        background-color: rgba(239, 68, 68, 0.2);
        color: var(--red);
        border: 1px solid var(--red);
    }
</style>
</body>
</html>